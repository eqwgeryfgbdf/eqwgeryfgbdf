name: æ¯æ—¥è‡ªå‹•æ›´æ–°

on:
  schedule:
    # æ¯å¤©å°ç£æ™‚é–“ä¸Šåˆ 9:00 åŸ·è¡Œ (UTC 01:00)
    - cron: '0 1 * * *'
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      custom_message:
        description: 'è‡ªå®šç¾©æäº¤ä¿¡æ¯'
        required: false
        default: 'ðŸ¤– æ‰‹å‹•è§¸ç™¼æ¯æ—¥æ›´æ–°'
        type: string

env:
  TZ: Asia/Taipei
  PYTHON_VERSION: '3.11'

jobs:
  daily-update:
    name: åŸ·è¡Œæ¯æ—¥æ›´æ–°
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ” é©—è­‰é…ç½®æ–‡ä»¶
        run: |
          python -c "
          import json
          try:
              with open('config.json', 'r') as f:
                  config = json.load(f)
              print('âœ… é…ç½®æ–‡ä»¶é©—è­‰é€šéŽ')
              print(f'æ™‚å€: {config[\"update_config\"][\"timezone\"]}')
              print(f'æ›´æ–°æ™‚é–“: {config[\"update_config\"][\"update_time\"]}')
          except Exception as e:
              print(f'âŒ é…ç½®æ–‡ä»¶éŒ¯èª¤: {e}')
              exit(1)
          "
      
      - name: ðŸš€ åŸ·è¡Œæ¯æ—¥æ›´æ–°è…³æœ¬
        run: |
          python update_daily_info.py
      
      - name: ðŸ“ æª¢æŸ¥æ–‡ä»¶è®Šæ›´
        id: verify-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ æª¢æ¸¬åˆ°æ–‡ä»¶è®Šæ›´"
            git status --porcelain
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ²’æœ‰æª¢æ¸¬åˆ°æ–‡ä»¶è®Šæ›´"
          fi
      
      - name: âš™ï¸ é…ç½® Git
        if: steps.verify-changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git config --local core.autocrlf false
      
      - name: ðŸ’¾ æäº¤è®Šæ›´
        if: steps.verify-changes.outputs.changes == 'true'
        run: |
          git add .
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            COMMIT_MSG="${{ github.event.inputs.custom_message }} - $(date '+%Y-%m-%d %H:%M') (Asia/Taipei)"
          else
            COMMIT_MSG="ðŸ¤– æ¯æ—¥è‡ªå‹•æ›´æ–° - $(date '+%Y-%m-%d %H:%M') (Asia/Taipei)"
          fi
          git commit -m "$COMMIT_MSG"
      
      - name: ðŸš€ æŽ¨é€è®Šæ›´
        if: steps.verify-changes.outputs.changes == 'true'
        run: |
          git push origin main
      
      - name: âœ… æ›´æ–°å®Œæˆé€šçŸ¥
        if: steps.verify-changes.outputs.changes == 'true'
        run: |
          echo "âœ… æ¯æ—¥æ›´æ–°å®Œæˆä¸¦å·²æŽ¨é€è‡³ GitHub"
          echo "ðŸ“… æ›´æ–°æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S') (Asia/Taipei)"
          echo "ðŸ”— æŸ¥çœ‹è®Šæ›´: https://github.com/${{ github.repository }}/commit/$(git rev-parse HEAD)"
      
      - name: â„¹ï¸ ç„¡è®Šæ›´é€šçŸ¥
        if: steps.verify-changes.outputs.changes == 'false'
        run: |
          echo "â„¹ï¸ ä»Šæ—¥ç„¡éœ€æ›´æ–°å…§å®¹"
          echo "ðŸ“… æª¢æŸ¥æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S') (Asia/Taipei)"
      
      - name: ðŸ“Š ç”ŸæˆåŸ·è¡Œå ±å‘Š
        if: always()
        run: |
          echo "## ðŸ“Š åŸ·è¡Œå ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- **åŸ·è¡Œæ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S') (Asia/Taipei)" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¸ç™¼æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python ç‰ˆæœ¬**: ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶è®Šæ›´**: ${{ steps.verify-changes.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.verify-changes.outputs.changes }}" = "true" ]; then
            echo "- **ç‹€æ…‹**: âœ… æ›´æ–°æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ç‹€æ…‹**: â„¹ï¸ ç„¡è®Šæ›´" >> $GITHUB_STEP_SUMMARY
          fi
