name: éƒ¨ç½²é…ç½®

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'
      - 'update_daily_info.py'
      - 'config.json'
      - 'requirements.txt'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

env:
  TZ: Asia/Taipei
  PYTHON_VERSION: '3.11'

jobs:
  validate:
    name: é©—è­‰é…ç½®
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: ðŸ è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: ðŸ“¦ å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ðŸ” é©—è­‰ Python è…³æœ¬èªžæ³•
        run: |
          python -m py_compile update_daily_info.py
          echo "âœ… Python è…³æœ¬èªžæ³•æª¢æŸ¥é€šéŽ"
      
      - name: ðŸ” é©—è­‰é…ç½®æ–‡ä»¶
        run: |
          python -c "
          import json
          import os
          
          # æª¢æŸ¥é…ç½®æ–‡ä»¶
          if not os.path.exists('config.json'):
              print('âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨')
              exit(1)
          
          try:
              with open('config.json', 'r') as f:
                  config = json.load(f)
              print('âœ… é…ç½®æ–‡ä»¶ JSON èªžæ³•æ­£ç¢º')
              
              # æª¢æŸ¥å¿…è¦å­—æ®µ
              required_fields = [
                  'update_config.timezone',
                  'update_config.update_time',
                  'update_config.files_to_update'
              ]
              
              for field in required_fields:
                  keys = field.split('.')
                  value = config
                  try:
                      for key in keys:
                          value = value[key]
                  except KeyError:
                      print(f'âŒ ç¼ºå°‘å¿…è¦é…ç½®é …: {field}')
                      exit(1)
              
              print('âœ… é…ç½®æ–‡ä»¶åŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ')
              print(f'æ™‚å€: {config[\"update_config\"][\"timezone\"]}')
              print(f'æ›´æ–°æ™‚é–“: {config[\"update_config\"][\"update_time\"]}')
              print(f'è¦æ›´æ–°çš„æ–‡ä»¶: {config[\"update_config\"][\"files_to_update\"]}')
              
          except json.JSONDecodeError as e:
              print(f'âŒ é…ç½®æ–‡ä»¶ JSON èªžæ³•éŒ¯èª¤: {e}')
              exit(1)
          except Exception as e:
              print(f'âŒ é…ç½®æ–‡ä»¶é©—è­‰å¤±æ•—: {e}')
              exit(1)
          "
      
      - name: ðŸ” æª¢æŸ¥æ–‡ä»¶å­˜åœ¨æ€§
        run: |
          echo "æª¢æŸ¥è¦æ›´æ–°çš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨..."
          python -c "
          import json
          import os
          
          with open('config.json', 'r') as f:
              config = json.load(f)
          
          files_to_check = config['update_config']['files_to_update']
          missing_files = []
          
          for file in files_to_check:
              if not os.path.exists(file):
                  missing_files.append(file)
          
          if missing_files:
              print(f'âŒ ä»¥ä¸‹æ–‡ä»¶ä¸å­˜åœ¨: {missing_files}')
              exit(1)
          else:
              print('âœ… æ‰€æœ‰è¦æ›´æ–°çš„æ–‡ä»¶éƒ½å­˜åœ¨')
          "
      
      - name: ðŸ§ª æ¸¬è©¦è…³æœ¬åŸ·è¡Œ
        run: |
          echo "æ¸¬è©¦è…³æœ¬åŸ·è¡Œï¼ˆä¸å¯¦éš›æ›´æ–°æ–‡ä»¶ï¼‰..."
          python -c "
          import sys
          sys.path.append('.')
          
          # æ¨¡æ“¬æ¸¬è©¦åŸ·è¡Œ
          try:
              from update_daily_info import DailyUpdater
              updater = DailyUpdater()
              print('âœ… è…³æœ¬åˆå§‹åŒ–æˆåŠŸ')
              print(f'ç•¶å‰æ™‚é–“: {updater.current_time}')
              print(f'æ—¥æœŸå­—ç¬¦ä¸²: {updater.date_str}')
              print(f'æ™‚é–“å­—ç¬¦ä¸²: {updater.time_str}')
          except Exception as e:
              print(f'âŒ è…³æœ¬æ¸¬è©¦å¤±æ•—: {e}')
              exit(1)
          "
      
      - name: ðŸ“Š ç”Ÿæˆé©—è­‰å ±å‘Š
        if: always()
        run: |
          echo "## ðŸ” é…ç½®é©—è­‰å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- **é©—è­‰æ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S') (Asia/Taipei)" >> $GITHUB_STEP_SUMMARY
          echo "- **Python ç‰ˆæœ¬**: ${{ env.PYTHON_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²ç’°å¢ƒ**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¸ç™¼åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: éƒ¨ç½²åˆ° ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: ðŸš€ éƒ¨ç½²å®Œæˆ
        run: |
          echo "âœ… éƒ¨ç½²åˆ° ${{ github.event.inputs.environment || 'production' }} ç’°å¢ƒå®Œæˆ"
          echo "ðŸ“… éƒ¨ç½²æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S') (Asia/Taipei)"
          echo "ðŸ”— éƒ¨ç½²æäº¤: ${{ github.sha }}"
      
      - name: ðŸ“Š ç”Ÿæˆéƒ¨ç½²å ±å‘Š
        run: |
          echo "## ðŸš€ éƒ¨ç½²å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²æ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S') (Asia/Taipei)" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²ç’°å¢ƒ**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ SHA**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
